<link rel="stylesheet" href="style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

<h1>hi reader, i'll get you something to read soon.</h1>
<h2>please input youtube id (ex: AFr4z1kvGBw)</h2>
<div style="text-align:center;" id="result"></div>
<input type="text" name="url" id="link_box" placeholder="Please input the Youtube ID" value="AFr4z1kvGBw">
<div class="spacer"></div>
<button id="link_box_submit_btn">Okay, here you go mate!</button>
<div id="error_001"></div>
<div id="yt_content"><div>

<script>
function xhttp_get_request(id,option){
	const cors = "https://cors-anywhere.herokuapp.com/;
	var yt_id = "https://youtube.com/get_video_info?video_id=";
	if (id.length > 11)
		var bypass_cors_link = cors + yt_id + id;
	else
		var bypass_cors_link = cors + id;
		
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function () {
	  if (xhr.readyState == XMLHttpRequest.DONE) {
		if (option === 'link')
			get_youtube_link(xhr.response);
		else if(option === 'content'){
			var success_response = decodeURIComponent(xhr.response);
			get_text_only(success_response);
		}
	  }
	};
	xhr.open("GET", bypass_cors_link , true);
	xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
	xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');
	xhr.send();
}

function get_youtube_link(response){
	var success_response = decodeURIComponent(response);
	const regex = /({"captionTracks":.*isTranslatable":(true|false)}])/;
	var youtube_url = JSON.parse(regex.exec(success_response)[0] + "}")["captionTracks"][0]["baseUrl"];
	document.getElementById("result").innerHTML = "<a href="+youtube_url+">Youtube Link</a>";
	return youtube_url;
}

function get_text_only(str){
	var pattern = /<text\b[^>]*>|<transcript>|<\?xml version="1\.0" encoding="utf-8" \?>|<\/transcript>/gm;
	var strip_the_tag = str.replace(pattern,'');
	var string_with_newline = strip_the_tag.replace(/<\/text>/gm, "</br>");
	document.getElementById("yt_content").innerHTML = string_with_newline.replace("&#39;","'");
}

document.querySelector("#link_box_submit_btn").addEventListener("click",
  function (event) {
	const video_id = document.getElementById("link_box").value;
	var yt_link = xhttp_get_request(video_id,'link');
	xhttp_get_request(yt_link,'content');
    event.preventDefault();
  },false
);

/*
// link that work:
https://jsonplaceholder.typicode.com/users/1
link that wont work:
https://postman-echo.com/get?foo1=bar1&foo2=bar2
https://youtube.com/get_video_info?video_id=AxI5r4_I5uA
*/
</script>
